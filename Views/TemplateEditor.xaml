<UserControl
    x:Class="MMCore.Views.TemplateEditor"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes">

    <!-- Keyboard shortcuts to close the parent dialog (RootDialog) -->
    <UserControl.InputBindings>
        <KeyBinding Key="Escape"
                    Command="{x:Static md:DialogHost.CloseDialogCommand}"
                    CommandParameter="Cancel"/>
        <KeyBinding Key="Enter" Modifiers="Control"
                    Command="{x:Static md:DialogHost.CloseDialogCommand}"
                    CommandParameter="{Binding}"/>
    </UserControl.InputBindings>

    <Grid Margin="24" md:ValidationAssist.UsePopup="True">

        <!-- Two columns: Quick Add | Editor -->
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="320"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- ===================== LEFT: QUICK ADD ===================== -->
        <Border Grid.Column="0" Margin="0,0,16,0" Padding="12"
                BorderThickness="1" CornerRadius="4"
                BorderBrush="{DynamicResource MaterialDesignDivider}">
            <DockPanel LastChildFill="True">

                <!-- Top controls -->
                <StackPanel DockPanel.Dock="Top">
                    <TextBlock Text="Quick Add" FontWeight="SemiBold" Margin="0,0,0,8" />

                    <Expander Header="Quick Add Tokens"
                              IsExpanded="{Binding IsQuickAddTokensExpanded, Mode=TwoWay}"
                              Margin="0,0,0,8">

                        <StackPanel>
                            <!-- Controls row -->
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                                <!-- Show literal {Q:...} -->
                                <ToggleButton
                                    Content="{}Use {Q:...}"
                                    IsChecked="{Binding UseQuotedTokens}"
                                    Margin="0,0,8,0" />
                                <CheckBox Content="Auto-quote tokens when needed"
                                          IsChecked="{Binding UseQuotedTokens}"
                                          VerticalAlignment="Center" />
                            </StackPanel>

                            <!-- Token buttons -->
                            <WrapPanel>
                                <Button Content="COM1" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="comport1" />
                                <Button Content="COM2" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="comport2" />
                                <Button Content="Username" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="username" />
                                <Button Content="Password" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="password" />
                                <Button Content="Opco" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="opco" />
                                <Button Content="Program" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="program" />
                                <Button Content="WD" Margin="0,0,8,8"
                                        Command="{Binding AddTokenCommand}" CommandParameter="wd" />
                            </WrapPanel>
                        </StackPanel>
                    </Expander>
                </StackPanel>

                <!-- Snippets -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding QuickAddCategories}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}" Margin="0,0,0,8">
                                    <Expander.Header>
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                    </Expander.Header>

                                    <ItemsControl ItemsSource="{Binding Items}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button Margin="0,0,0,6"
                                                        HorizontalContentAlignment="Left"
                                                        Content="{Binding Name}"
                                                        ToolTip="{Binding Description}"
                                                        Command="{Binding DataContext.AddSnippetCommand,
                                                                          RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}"
                                                        CommandParameter="{Binding}"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Expander>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

            </DockPanel>
        </Border>

        <!-- ===================== RIGHT: MAIN EDITOR ===================== -->
        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
            <StackPanel Orientation="Vertical" Margin="0,0,0,16">

                <!-- Header row: Combo + Name (left), Actions (right) -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Left side: Templates combo + Name -->
                    <StackPanel Orientation="Vertical" Grid.Column="0">
                        <ComboBox x:Name="TemplatesCombo"
                                  Width="360"
                                  ItemsSource="{Binding DataContext.Templates, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                  SelectedItem="{Binding DataContext.SelectedTemplate, RelativeSource={RelativeSource AncestorType={x:Type Window}}, Mode=TwoWay}"
                                  DisplayMemberPath="Name"
                                  IsEditable="False"
                                  MaxDropDownHeight="300"
                                  Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                  md:HintAssist.Hint="Templates" />


                        <md:DialogHost IsOpen="{Binding IsSaveAsPromptOpen}">
                            <md:DialogHost.DialogContent>
                                <StackPanel Width="360">
                                    <TextBlock Text="Save Template As"
                       Style="{StaticResource MaterialDesignHeadline6TextBlock}"/>
                                    <TextBox Margin="0,12,0,0"
                     md:HintAssist.Hint="Template name"
                     Text="{Binding SaveAsProposedName, UpdateSourceTrigger=PropertyChanged}"/>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
                                        <Button Content="Cancel"
                        Command="{Binding CancelSaveAsPromptCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}" />
                                        <Button Content="OK"
                        Margin="8,0,0,0"
                        Command="{Binding ConfirmSaveAsPromptCommand}"
                        Style="{StaticResource MaterialDesignRaisedButton}" />
                                    </StackPanel>
                                </StackPanel>
                            </md:DialogHost.DialogContent>
                        </md:DialogHost>

                    </StackPanel>

                    <!-- Right side: Action buttons -->
                    <StackPanel Orientation="Horizontal" Grid.Column="1" VerticalAlignment="Top">
                        <Button Content="Delete"
                                Command="{Binding DeleteCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Foreground="{DynamicResource MaterialDesignValidationErrorBrush}"
                                ToolTip="Delete this template" />

                        <Button Content="Save As..."
                                Margin="8,0,0,0"
                                Command="{Binding SaveAsCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                ToolTip="Create a copy with a new name" />

                        <Button Content="Save"
                                Margin="8,0,0,0"
                                Command="{Binding SaveCommand}"
                                Style="{StaticResource MaterialDesignRaisedButton}"
                                ToolTip="Save changes" />

                        <Button Content="Close"
                                Margin="8,0,0,0"
                                Command="{x:Static md:DialogHost.CloseDialogCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}" />
                    </StackPanel>
                </Grid>

                <!-- Optional section label -->
                <TextBlock Margin="0,16,0,8"
                           Text="Sequence Builder"
                           FontWeight="SemiBold" />

                <!-- Main Template editor -->
                <TextBox
                    md:HintAssist.Hint="Template Text (supports tokens like {comport1}, {username}, {Q:program})"
                    AcceptsReturn="True"
                    TextWrapping="Wrap"
                    Height="160"
                    VerticalScrollBarVisibility="Auto"
                    Text="{Binding Template, UpdateSourceTrigger=PropertyChanged, ValidatesOnNotifyDataErrors=True, NotifyOnValidationError=True}"/>

                <!-- Clear sits BELOW the Template editor (right-aligned) -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                    <Button
                        Command="{Binding ClearSequenceCommand}"
                        ToolTip="Clear sequence"
                        Style="{StaticResource MaterialDesignFlatButton}">
                        <StackPanel Orientation="Horizontal">
                            <md:PackIcon Kind="DeleteSweepOutline" Width="20" Height="20" Margin="0,0,4,0"/>
                            <TextBlock Text="Clear" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Raw template preview (tokens intact) -->
                <GroupBox Header="Template (raw / token expression)" Margin="0,16,0,0">
                    <TextBox Text="{Binding Template, Mode=OneWay}"
                             FontFamily="Consolas"
                             FontSize="12"
                             IsReadOnly="True"
                             BorderThickness="0"
                             Background="Transparent"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             VerticalScrollBarVisibility="Auto"/>
                </GroupBox>

            </StackPanel>
        </ScrollViewer>

    </Grid>
</UserControl>